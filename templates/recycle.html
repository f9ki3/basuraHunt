<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BasuraHunt</title>
    {% include 'header_links.html' %}
</head>
<body>
    {% include 'nav.html' %}
    <div class="container pt-3">
        <div id="loader_spn">
            <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        <div id="content_userwaste" style="display: none;">
            <div class="row">
                <div class="col-12 col-md-6">
                    <div class="col-12 col-md-12 col-lg-12" style="color: hsl(40, 4%, 14%);">
                    <div class="border shadow p-4 rounded-4 mb-3" style="height: auto;">
                        <div id="post_content">
                            <h1 class="text-start fw-bolder w-100">Recycle Submission</h1>
                            <div class="col-12 mb-3 mt-2">
                                <label for="productSelect" class="form-label" style="font-size: 12px;">Select Product</label>
                                <select class="form-select" id="productSelect" aria-label="Select Product">
                                    <option value="">Select a Product</option>
                                    <option value="plastic_bottle">Plastic Bottle</option>
                                    <option value="papers">Papers</option>
                                    <option value="metal">Metal</option>
                                </select>
                                <div id="productError" class="text-danger" style="font-size: 12px;"></div>
                            </div>
                            <div class="row mb-3 g-3">
                                <div class="col-12 col-md-6">
                                    <label for="gradeSelect" class="form-label" style="font-size: 12px;">Grade Level</label>
                                    <select class="form-select" id="gradeSelect" aria-label="Grade Level">
                                        <option value="">Select Grade Level</option>
                                        <option value="11">Grade 11</option>
                                        <option value="12">Grade 12</option>
                                    </select>
                                    <div id="gradeError" class="text-danger" style="font-size: 12px;"></div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="strandSelect" class="form-label" style="font-size: 12px;">Select Strand</label>
                                    <select class="form-select" id="strandSelect" aria-label="Select Strand">
                                        <option value="">Select Strand</option>
                                        <option value="GAS">GAS</option>
                                        <option value="STEM">STEM</option>
                                        <option value="ICT">ICT</option>
                                        <option value="ABM">ABM</option>
                                        <option value="HUMSS">HUMSS</option>
                                        <option value="HE">HE</option>
                                        <option value="ALS">ALS</option>
                                        <option value="SMAW">SMAW</option>
                                    </select>
                                    <div id="strandError" class="text-danger" style="font-size: 12px;"></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="sectionSelect" class="form-label" style="font-size: 12px;">Section</label>
                                <select class="form-select" id="sectionSelect" aria-label="Select Section">
                                    <option value="">Select Section</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                                <div id="sectionError" class="text-danger" style="font-size: 12px;"></div>
                            </div>
                            <div class="col-12 mt-3">
                                <label for="quantityInput" class="form-label" style="font-size: 12px;">Quantity</label>
                                <input type="text" id="quantityInput" placeholder="Enter your product quantity" class="form-control" aria-label="Quantity">
                                <div id="quantityError" class="text-danger" style="font-size: 12px;"></div>
                            </div>
                            <button type="submit" id="submitBtn" class="border mt-3 w-100 btn-lg fs-6 btn d-flex align-items-center justify-content-center" style="background-color: #2d6979; color: white;">
                                <div id="sub_btn">
                                    <i class="bi fs-3 bi-reply me-2"></i>Submit Recycle
                                </div>
                                <!-- Spinner element -->
                                <div id="spinner" class="spinner-border text-light d-none" role="status" style="width: 1.5rem; height: 1.5rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </div>
                        
                    </div>
                </div>
                
                
            
                <div class="col-12 col-md-12 col-lg-12" style="color: hsl(40, 4%, 14%);">
                    <div class="border shadow p-4 rounded-4 mb-3" style="height: auto;">
                        <div id="post_content">
                            <h1 class="text-start fw-bolder w-100">Reward Guide</h1>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <td>
                                            <p>Product</p>
                                        </td>
                                        <td>
                                            <p>Unit</p>
                                        </td>
                                        <td>
                                            <p>Points</p>
                                        </td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <p>Papers</p>
                                        </td>
                                        <td>
                                            <p>1kg</p>
                                        </td>
                                        <td>
                                            <p>1 points</p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <p>Plastic Bottle</p>
                                        </td>
                                        <td>
                                            <p>1kg</p>
                                        </td>
                                        <td>
                                            <p>1 points</p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <p>Metal</p>
                                        </td>
                                        <td>
                                            <p>1kg</p>
                                        </td>
                                        <td>
                                            <p>1 points</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div> 
                </div>    
                </div>

                <div class="col-12 col-md-6 col-lg-6" style="color: hsl(40, 4%, 14%);">
                    <div class="border shadow p-4 rounded-4 mb-3">
                        <div id="post_content">
                            <h1 class="text-start fw-bolder w-100">Ranking of Sections</h1>
                            <div id="ranking_students"></div>
                            <script>
                                $(document).ready(function() {
                                    let previousData = null; // Store the previous data to compare
                                
                                    function fetchAndUpdateChart() {
                                        // AJAX request to fetch data
                                        $.ajax({
                                            url: "/get_all_recycle_points_students",
                                            method: "GET",
                                            dataType: "json", // Ensures response is automatically parsed as JSON
                                            success: function(response) {
                                                // Extract sections and points from the response
                                                const sections = response.sections;
                                                const points = response.points;
                                
                                                // Combine sections and points into a single data structure
                                                const currentData = sections.map((section, index) => ({
                                                    section,
                                                    point: points[index]
                                                }));
                                
                                                // Check if data has changed
                                                if (JSON.stringify(currentData) !== JSON.stringify(previousData)) {
                                                    previousData = currentData; // Update the previous data
                                
                                                    // Separate sections and points
                                                    const chartSections = currentData.map(item => item.section);
                                                    const chartPoints = currentData.map(item => item.point);
                                
                                                    // Assign colors based on points (different color for zero points)
                                                    const barColors = currentData.map(item => (item.point === 0 ? '#cccccc' : '#2d6979'));
                                
                                                    // Calculate dynamic height based on the number of sections
                                                    const chartHeight = Math.max(chartSections.length * 30, 350); // Minimum height of 350px
                                
                                                    // Chart options
                                                    const options = {
                                                        series: [{
                                                            data: chartPoints // Include all points
                                                        }],
                                                        chart: {
                                                            type: 'bar',
                                                            height: chartHeight // Dynamic height
                                                        },
                                                        plotOptions: {
                                                            bar: {
                                                                borderRadius: 4,
                                                                borderRadiusApplication: 'end',
                                                                horizontal: true,
                                                            }
                                                        },
                                                        colors: barColors, // Apply custom colors
                                                        dataLabels: {
                                                            enabled: false
                                                        },
                                                        xaxis: {
                                                            categories: chartSections // Include all sections
                                                        }
                                                    };
                                
                                                    // Render the chart
                                                    $("#ranking_students").empty(); // Clear the old chart
                                                    const chart = new ApexCharts(document.querySelector("#ranking_students"), options);
                                                    chart.render();
                                                }
                                            },
                                            error: function(xhr, status, error) {
                                                console.error("Failed to fetch data:", error);
                                            }
                                        });
                                    }
                                
                                    // Polling interval (e.g., every 5 seconds)
                                    setInterval(fetchAndUpdateChart, 1000);
                                
                                    // Initial fetch
                                    fetchAndUpdateChart();
                                });
                                
                            </script>
                                
                        </div>
                    </div> 
                </div>    
                </div>   
            </div>            
        </div>
    </div>
    {% include 'footer_links.html' %}
</body>
</html>

